<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups - SSB Academy</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="navbar-brand">âš½ SSB Academy</a>
                <ul class="navbar-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="players.html">Players</a></li>
                    <li><a href="coaches.html">Coaches</a></li>
                    <li><a href="groups.html">Groups</a></li>
                    <li><a href="schedules.html">Schedules</a></li>
                    <li><a href="swagger.html">API Docs</a></li>
                </ul>
                <div class="auth-section" id="authSection"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="page-header">
                <h1 class="page-title">Kelompok Latihan</h1>
                <p class="page-subtitle">Manage training groups</p>
            </div>

            <!-- Search & Filter Bar -->
            <div class="search-bar">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="form-input search-input" 
                    placeholder="Search groups..."
                >
                <select id="orderSelect" class="form-select" style="min-width: 150px;">
                    <option value="name">Sort by Name (A-Z)</option>
                    <option value="-name">Sort by Name (Z-A)</option>
                </select>
                <button id="addGroupBtn" class="btn btn-primary" onclick="window.location.href='group-add.html'" style="display: none;">
                    + Add Group
                </button>
            </div>

            <!-- Groups Container -->
            <div id="groupsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading groups...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        let currentOrdering = 'name';

        async function loadGroups() {
            showLoading('groupsContainer');
            
            try {
                const queryParams = new URLSearchParams({
                    page: currentPage,
                    search: currentSearch,
                    ordering: currentOrdering,
                });

                const data = await apiRequest(`/groups/?${queryParams}`);
                
                if (!data || !data.results) {
                    throw new Error('Invalid response');
                }

                displayGroups(data.results);
                displayPagination(data);
            } catch (error) {
                console.error('Error loading groups:', error);
                document.getElementById('groupsContainer').innerHTML = `
                    <div class="alert alert-error">
                        Failed to load groups. ${error.message}
                    </div>
                `;
            }
        }

        function displayGroups(groups) {
            const container = document.getElementById('groupsContainer');
            const isAuth = isAuthenticated();
            
            if (groups.length === 0) {
                container.innerHTML = `
                    <div class="card text-center">
                        <p style="color: #94a3b8;">No groups found.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="grid grid-2">` + groups.map(group => {
                return `
                    <div class="card">
                        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem; color: #60a5fa;">
                            ${group.name}
                        </h3>
                        ${group.description ? `<p style="color: #94a3b8; margin-bottom: 1rem;">${group.description}</p>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #334155;">
                            <div>
                                <p style="color: #64748b; font-size: 0.875rem;">Coach:</p>
                                <p style="color: #e2e8f0; font-weight: 600;">${group.coach_name || 'No coach assigned'}</p>
                            </div>
                        </div>
                        ${isAuth ? `
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button onclick="window.location.href='group-edit.html?id=${group.id}'" class="btn btn-primary" style="flex: 1;">
                                    Edit
                                </button>
                                <button class="btn btn-danger delete-group-btn" style="flex: 1;" data-id="${group.id}" data-name="${group.name}">
                                    Delete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('') + `</div>`;

            // Add event listeners for delete buttons
            if (isAuth) {
                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const name = this.getAttribute('data-name');
                        deleteGroup(id, name);
                    });
                });
            }
        }

        async function deleteGroup(id, name) {
            if (!confirm(`Are you sure you want to delete group "${name}"?`)) {
                return;
            }

            try {
                await apiRequest(`/groups/${id}/`, {
                    method: 'DELETE',
                });
                showAlert(`Group "${name}" deleted successfully`, 'success');
                loadGroups();
            } catch (error) {
                console.error('Error deleting group:', error);
                showAlert('Failed to delete group: ' + error.message, 'error');
            }
        }

        function displayPagination(data) {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(data.count / 10);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button ${!data.previous ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button ${i === currentPage ? 'class="active"' : ''} onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span style="padding: 0.5rem;">...</span>`;
                }
            }
            
            html += `<button ${!data.next ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadGroups();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('searchInput').addEventListener('input', debounce((e) => {
            currentSearch = e.target.value;
            currentPage = 1;
            loadGroups();
        }, 500));

        document.getElementById('orderSelect').addEventListener('change', (e) => {
            currentOrdering = e.target.value;
            currentPage = 1;
            loadGroups();
        });

        // Show add button if authenticated
        if (isAuthenticated()) {
            document.getElementById('addGroupBtn').style.display = 'block';
        }

        loadGroups();
    </script>
</body>
</html>
